<!DOCTYPE HTML>
<html lang="en">
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Events | Introduction</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.6.7">
        
        
        <meta name="HandheldFriendly" content="true">
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="../gitbook/style.css">
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-anchors/plugin.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-highlight/website.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-search/search.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-fontsettings/website.css">
        
    
    

        
    
    
    <link rel="next" href="../references/References.html">
    
    
    <link rel="prev" href="../api-operation/ApiOperation.html">
    

        
    </head>
    <body>
        
        
    <div class="book" data-level="19" data-chapter-title="Events" data-filepath="events/events.md" data-basepath=".." data-revision="Mon Aug 14 2017 11:36:04 GMT+0000 (UTC)" data-innerlanguage="">
    

<div class="book-summary">
    <nav role="navigation">
        <ul class="summary">
            
            
            
            

            

            
    
        <li class="chapter " data-level="1" data-path="TOC.html">
            
                
                    <a href="../TOC.html">
                
                        <i class="fa fa-check"></i>
                        
                            
                        
                        Table of Contents
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                
                        <i class="fa fa-check"></i><b>1.</b>
                        
                        Introduction
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2" data-path="design-principles/DesignPrinciples.html">
            
                
                    <a href="../design-principles/DesignPrinciples.html">
                
                        <i class="fa fa-check"></i><b>2.</b>
                        
                            
                        
                        Principles
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3" data-path="general-guidelines/GeneralGuidelines.html">
            
                
                    <a href="../general-guidelines/GeneralGuidelines.html">
                
                        <i class="fa fa-check"></i><b>3.</b>
                        
                            
                        
                        General Guidelines
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4" data-path="security/Security.html">
            
                
                    <a href="../security/Security.html">
                
                        <i class="fa fa-check"></i><b>4.</b>
                        
                            
                        
                        Security
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5" data-path="compatibility/Compatibility.html">
            
                
                    <a href="../compatibility/Compatibility.html">
                
                        <i class="fa fa-check"></i><b>5.</b>
                        
                            
                        
                        Compatibility
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6" data-path="json-guidelines/JsonGuidelines.html">
            
                
                    <a href="../json-guidelines/JsonGuidelines.html">
                
                        <i class="fa fa-check"></i><b>6.</b>
                        
                            
                        
                        JSON Guidelines
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="7" data-path="naming/Naming.html">
            
                
                    <a href="../naming/Naming.html">
                
                        <i class="fa fa-check"></i><b>7.</b>
                        
                            
                        
                        Naming
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="8" data-path="resources/Resources.html">
            
                
                    <a href="../resources/Resources.html">
                
                        <i class="fa fa-check"></i><b>8.</b>
                        
                            
                        
                        Resources
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9" data-path="http/Http.html">
            
                
                    <a href="../http/Http.html">
                
                        <i class="fa fa-check"></i><b>9.</b>
                        
                            
                        
                        HTTP
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="10" data-path="performance/Performance.html">
            
                
                    <a href="../performance/Performance.html">
                
                        <i class="fa fa-check"></i><b>10.</b>
                        
                            
                        
                        Performance
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="11" data-path="pagination/Pagination.html">
            
                
                    <a href="../pagination/Pagination.html">
                
                        <i class="fa fa-check"></i><b>11.</b>
                        
                            
                        
                        Pagination
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="12" data-path="hyper-media/Hypermedia.html">
            
                
                    <a href="../hyper-media/Hypermedia.html">
                
                        <i class="fa fa-check"></i><b>12.</b>
                        
                            
                        
                        Hypermedia
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="13" data-path="data-formats/DataFormats.html">
            
                
                    <a href="../data-formats/DataFormats.html">
                
                        <i class="fa fa-check"></i><b>13.</b>
                        
                            
                        
                        Data Formats
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="14" data-path="common-data-types/CommonDataTypes.html">
            
                
                    <a href="../common-data-types/CommonDataTypes.html">
                
                        <i class="fa fa-check"></i><b>14.</b>
                        
                            
                        
                        Common Data Types
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="15" data-path="headers/CommonHeaders.html">
            
                
                    <a href="../headers/CommonHeaders.html">
                
                        <i class="fa fa-check"></i><b>15.</b>
                        
                            
                        
                        Common Headers
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="16" data-path="headers/ProprietaryHeaders.html">
            
                
                    <a href="../headers/ProprietaryHeaders.html">
                
                        <i class="fa fa-check"></i><b>16.</b>
                        
                            
                        
                        Proprietary Headers
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="17" data-path="deprecation/Deprecation.html">
            
                
                    <a href="../deprecation/Deprecation.html">
                
                        <i class="fa fa-check"></i><b>17.</b>
                        
                            
                        
                        Deprecation
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="18" data-path="api-operation/ApiOperation.html">
            
                
                    <a href="../api-operation/ApiOperation.html">
                
                        <i class="fa fa-check"></i><b>18.</b>
                        
                            
                        
                        API Operation
                    </a>
            
            
        </li>
    
        <li class="chapter active" data-level="19" data-path="events/events.html">
            
                
                    <a href="../events/events.html">
                
                        <i class="fa fa-check"></i><b>19.</b>
                        
                            
                        
                        Events
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="20" data-path="references/References.html">
            
                
                    <a href="../references/References.html">
                
                        <i class="fa fa-check"></i><b>20.</b>
                        
                            
                        
                        References
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="21" data-path="tooling/Tooling.html">
            
                
                    <a href="../tooling/Tooling.html">
                
                        <i class="fa fa-check"></i><b>21.</b>
                        
                            
                        
                        Tooling
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="22" data-path="changelog/Changelog.html">
            
                
                    <a href="../changelog/Changelog.html">
                
                        <i class="fa fa-check"></i><b>22.</b>
                        
                            
                        
                        Changelog
                    </a>
            
            
        </li>
    


            
            <li class="divider"></li>
            <li>
                <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                    Published with GitBook
                </a>
            </li>
            
        </ul>
    </nav>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
    <!-- Actions Left -->
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../">Introduction</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <h1 id="events">Events</h1>
<p>Zalando&#x2019;s architecture centers around decoupled microservices and in that context we favour asynchronous event driven approaches. The guidelines in this section focus on how to design and publish events intended to be shared for others to consume. </p>
<p><strong>Events, Event Types and Categories.</strong></p>
<p>Events are defined using an item called an <em>Event Type</em>. The Event Type allows
events to have their structure declared  with a schema by producers and understood by
consumers. An Event Type declares standard information, such as a name, an owning
application (and by implication, an owning team), a schema defining the event&apos;s
custom data, and a compatibility mode declaring how the schema will be
evolved. Event Types also allow the declaration of validation and enrichment
strategies for events, along with supplemental information such as how events
can be partitioned in an event stream.</p>
<p>Event Types belong to a well known <em>Event Category</em> (such as a data change
category), which provides extra information that is common to that kind of
event.</p>
<p>Event Types can be published and made available as API resources for teams to
use, typically in an <em>Event Type Registry</em>. Each event published can then be
validated against the overall structure of its event type and the schema for its
custom data.</p>
<p>The basic model described above was originally developed in the
<a href="https://github.com/zalando/nakadi" target="_blank">Nakadi project</a>, which acts as a reference
implementation of the event type registry, and as a validating publish/subscribe
broker for event producers and consumers.</p>
<h2 id="must-treat-events-as-part-of-the-service-interface"><span style="color:red;font-weight:bold">Must:</span> Treat Events as part of the service interface</h2>
<p>Events are part of a service&#x2019;s interface to the outside world equivalent in standing to a service&#x2019;s REST API. Services publishing data for integration must treat their events as a first class design concern, just as they would an API. For example this means approaching events with the &quot;API first&quot; principle in mind <a href="../index.html">as described in the Introduction</a>.</p>
<h2 id="must-make-events-available-for-review"><span style="color:red;font-weight:bold">Must:</span> Make Events available for review</h2>
<p>Services publishing event data for use by others must make the event schema available for review. </p>
<h2 id="must-ensure-event-type-schemas-conform-to-open-apis-schema-object"><span style="color:red;font-weight:bold">Must:</span> Ensure Event Type schemas conform to Open API&apos;s Schema Object</h2>
<p>Event type schema are defined in accordance with the Open API Schema Object
specification, which uses a subset of
<a href="http://json-schema.org/" target="_blank">JSON Schema Draft 4</a>, and also adds other
features. This allows events to properly align with API resource representations
(it&apos;s particulary useful for events that represent data changes about
resources). The guideline exists since declaring event type schema using
JSON-Schema syntax is common practice (because Open API doesn&apos;t yet allow
standalone object definitions).</p>
<p>In the rest of this section we&apos;ll call out some of the more notable differences
between Open API and JSON-Schema. Please note this is not a complete list - in
general it&apos;s recommended to familiarise yourself with Open API&apos;s Schema Object
(the details are available from the
<a href="https://github.com/OAI/OpenAPI-Specification/blob/master/versions/2.0.md#schemaObject" target="_blank">&quot;Schema Object&quot; section of that specification</a>).</p>
<p>Open API <em>removes</em> some JSON-Schema keywords. These must not be used in event
type schemas. The list of Open API object keywords can be seen
<a href="https://github.com/OAI/OpenAPI-Specification/blob/master/schemas/v2.0/schema.json#L935-L1063" target="_blank">here</a>,
but for convenience the list of non-available keywords relative to JSON-Schema
are:</p>
<ul>
<li><code>additionalItems</code></li>
<li><code>contains</code></li>
<li><code>patternProperties</code></li>
<li><code>dependencies</code></li>
<li><code>propertyNames</code></li>
<li><code>const</code></li>
<li><code>not</code></li>
<li><code>oneOf</code></li>
</ul>
<p>Open API <em>redefines</em> some keywords:</p>
<ul>
<li><code>additionalProperties</code>: For event types that declare compatibility
guarantees, there are recommended constraints around the use of this
field. See the guideline &quot;Avoid <code>additionalProperties</code> in event type
definitions&quot; for details.</li>
</ul>
<p>Open API <em>extends</em> JSON-Schema with some keywords:</p>
<ul>
<li><p><code>readOnly</code>: events are logically immutable, so <code>readOnly</code> can be considered
redundant, but harmless.</p>
</li>
<li><p><code>discriminator</code>: discriminators exist to support polymorphism and act as an 
alternative to <code>oneOf</code>. </p>
</li>
<li><p><code>^x-</code>: patterned objects in the form of
<a href="https://github.com/OAI/OpenAPI-Specification/blob/master/versions/2.0.md#vendorExtensions" target="_blank">vendor extensions</a>
can be used in event type schema, but it might be the case that general
purpose validators do not understand them to enforce a validation check, and
fall back to must-ignore processing. A future version of the guidelines may
define well known vendor extensions for events.</p>
</li>
</ul>
<h2 id="must-ensure-that-events-are-registered-as-event-types"><span style="color:red;font-weight:bold">Must:</span> Ensure that Events are registered as Event Types</h2>
<p>In Zalando&apos;s architecture, events are registered using a structure called an
<em>Event Type</em>. The Event Type declares standard information as follows:</p>
<ul>
<li>A well known event category, such as a general or data change category.</li>
<li>The name of the event type.</li>
<li>An owning application, and by implication, an owning team.</li>
<li>A schema defining the event payload. </li>
<li>The compatability mode for the type.</li>
</ul>
<p>Event Types allow easier discovery of event information and ensure that
information is well-structured, consistent, and can be validated.</p>
<p>Event type owners must pay attention to the choice of compatability mode.  The
mode provides a means to evolve thee schema. The range of modes are designed to
be flexible enough so that producers can evolve schemas while not inadvertently
breaking existing consumers:</p>
<ul>
<li><p>&apos;none&apos;: Any schema modification is accepted, even if it might break existing
producers or consumers. When validating events, undefined properties are
accepted unless declared in the schema.</p>
</li>
<li><p>&apos;forward&apos;: A schema <code>S1</code> is forward compatible if the previously registered 
schema, <code>S0</code> can read events defined by <code>S1</code>  - that is, consumers can read 
events tagged with the latest schema version using the previous version as 
long as consumers follow the robustness principle described in the guideline&apos;s
<a href="../DesignPrinciples.md">API Design Principles</a>.</p>
</li>
<li><p>&apos;compatible&apos;: This means changes are fully compatible. A new schema, <code>S1</code>, 
is fully compatible when every event published since the first schema version 
will validate against to the new schema. When in compatible mode, it&apos;s allowed 
to add new optional properties and definitions to an existing schema, but no other
changes are allowed. </p>
</li>
</ul>
<p>The compatibility levels interact with revision numbers in the schema
<code>&quot;version&quot;</code> field, which follows semantic versioning (MAJOR.MINOR.PATCH):</p>
<ul>
<li><p>Changing a <code>&quot;compatible&quot;</code> level type can lead to a PATCH or MINOR version
revision. MAJOR breaking changes are not allowed.</p>
</li>
<li><p>Changing a <code>&quot;forward&quot;</code> level event type can lead to a PATCH or MINOR
version revision. MAJOR breaking changes are not allowed.</p>
</li>
<li><p>Changing a <code>&quot;none&quot;</code> level event type can lead to PATCH, MINOR or MAJOR
level changes.</p>
</li>
</ul>
<p>For examples of changes:</p>
<ul>
<li><p>Changes to the event type&apos;s <code>&quot;title&quot;</code> or <code>&quot;description&quot;</code> are considered PATCH
level.</p>
</li>
<li><p>Adding new optional fields to an event type&apos;s schema is considered a MINOR
level change.</p>
</li>
<li><p>All other changes are considered MAJOR level, such as renaming or removing
fields, or adding new required fields.</p>
</li>
</ul>
<p>The core Event Type structure is shown below as an Open API object definition:</p>
<pre><code class="lang-yaml">EventType:
    description: | 
      An event type defines the schema and its runtime properties. The required
      fields are the minimum set the creator of an event type is expected to
      supply.
    required:
      - name
      - category
      - owning_application
      - schema    
    properties:
      name:
        description: |
          Name of this EventType.  Note: the name can encode the
          owner/responsible for this EventType and ideally should follow the
          common pattern &apos;functional-component&apos;.&apos;business event or entity&apos; that
          makes it easy to read and understand.
        type: string
        pattern: &apos;[a-zA-Z][-0-9a-zA-Z_]*(\.[a-zA-Z][-0-9a-zA-Z_]*)*&apos;
        example: order.order_cancelled, business_partner.contract
      owning_application:
        description: |
          Name of the application (eg, as would be used in infrastructure
          application or service registry) owning this `EventType`.
        type: string
        example: price-service
      category:
        description: Defines the category of this EventType. 
        type: string
        x-extensible-enum:
          - data
          - general
      compatibility_mode:
        description: |
          The compatibility modes are:
            - &quot;compatible&quot;
            - &quot;forward&quot;
            - &quot;none&quot;
        type: string
        default: forward
      schema:
        description: The most recent payload schema for this EventType. 
        type: object
        properties:
          version:
            description: Values are based on semantic versioning (eg &quot;1.2.1&quot;). 
            type: string
            default: &apos;1.0.0&apos;
          created_at:
            description: Creation timestamp of the schema. 
            type: string
            readOnly: true
            format: date-time
            example: &apos;1996-12-19T16:39:57-08:00&apos;
          type:
            description: | 
               The schema language of schema definition. Currently only
               json_schema (JSON Schema v04) syntax is defined, but in the
               future there could be others.
            type: string
            x-extensible-enum:
              - json_schema
          schema:
            description: | 
                The schema as string in the syntax defined in the field type.
            type: string
        required:
          - type
          - schema
      created_at:
        description: When this event type was created.      
        type: string
        pattern: date-time
      updated_at:
        description: When this event type was last updated.      
        type: string
        pattern: date-time
</code></pre>
<p>APIs such as registries supporting event types, may extend the model, including
the set of supported categories and schema formats. For example the Nakadi API&apos;s
event category registration also allows the declaration of validation and
enrichment strategies for events, along with supplemental information, such as
how events are partitioned in the stream.</p>
<h2 id="must-ensure-events-conform-to-a-wellknown-event-category"><span style="color:red;font-weight:bold">Must:</span> Ensure Events conform to a well-known Event Category</h2>
<p>An <em>event category</em> describes a generic class of event. The guidelines define
two such categories:</p>
<ul>
<li><p>General Event: a general purpose category.</p>
</li>
<li><p>Data Change Event: a category used for describing changes to data entities
used for data replication based data integration.</p>
</li>
</ul>
<p>The set of categories is expected to evolve in the future.</p>
<p>A category describes a predefined structure that event publishers must conform
to along with standard information about that kind of event (such as the
operation for a data change event).</p>
<p><strong>The General Event Category.</strong></p>
<p>The structure of the <em>General Event Category</em> is shown below as an Open API
Schema Object definition:</p>
<pre><code class="lang-yaml">  GeneralEvent:
    description: |
      A general kind of event. Event kinds based on this event define their
      custom schema payload as the top level of the document, with the
      &quot;metadata&quot; field being required and reserved for standard metadata. An
      instance of an event based on the event type thus conforms to both the
      EventMetadata definition and the custom schema definition. Previously this
      category was called the Business Category
    required:
      - metadata
    properties:
      metadata:
          $ref: &apos;#/definitions/EventMetadata&apos;
</code></pre>
<p>Event types based on the General Event Category define their custom schema payload 
at the top-level of the document, with the <code>metadata</code> field being reserved for 
standard information (the contents of <code>metadata</code> are described further down in 
this section).</p>
<p>In the example fragment below, the reserved metadata field is shown with fields
&quot;a&quot; and &quot;b&quot; being defined as part of the custom schema:</p>
<pre style="font-size: .85em">
  {
    <span style="font-weight: bold;">&quot;metadata&quot; : {...}</span>
    <span style="color: blue;">&quot;a&quot;: &quot;a1&quot;,</span>
    <span style="color: blue;">&quot;b&quot;: &quot;b1&quot;</span>
  }
</pre>

<p>Note: </p>
<ul>
<li><p>The General Event in a previous version of the guidelines was called a
<em>Business Event</em>.  Implementation experience has shown that the category&apos;s
structure gets used for other kinds of events, hence the name has been
generalized to reflect how teams are using it. </p>
</li>
<li><p>The General Event is still useful and recommended for the purpose of 
defining events that drive a business process.</p>
</li>
<li><p>The Nakadi broker still refers to the General Category as the Business 
Category and uses the keyword &quot;business&quot; for event type registration. 
Other than that, the JSON structures are identical.</p>
</li>
</ul>
<p>See
<a href="event.md#must-use-the-general-event-category-to-signal-steps-and-arrival-points-in-business-processes">&quot;Use Business Events to signal steps and arrival points in business processes&quot;</a>
for more guidance on how to use the category.</p>
<p><strong>The Data Change Event Category.</strong></p>
<p>The <em>Data Change Event Category</em> structure is shown below as an Open API Schema
Object:</p>
<pre><code class="lang-yaml">  DataChangeEvent:
     description: |
        Represents a change to an entity. The required fields are those expected
        to be sent by the producer, other fields may be added by intermediaries
        such as a publish/subcribe broker. An instance of an event based on the
        event type conforms to both the DataChangeEvent&apos;s definition and the
        custom schema definition.      
    required:
      - metadata
      - data_op
      - data_type
      - data    
    properties:
      metadata:
        description: The metadata for this event.
        $ref: &apos;#/definitions/EventMetadata&apos;
      data:
        description: | 
          Contains custom payload for the event type. The payload must conform
          to a schema associated with the event type declared in the metadata
          object&apos;s `event_type` field.                
        type: object
      data_type:     
        description: name of the (business) data entity that has been mutated
        type: string
        example: &apos;sales_order.order&apos;
      data_op:
        type: string
        enum: [&apos;C&apos;, &apos;U&apos;, &apos;D&apos;, &apos;S&apos;]
        description: |
          The type of operation executed on the entity:

          - C: Creation of an entity
          - U: An update to an entity.
          - D: Deletion of an entity.
          - S: A snapshot of an entity at a point in time.
</code></pre>
<p>The Data Change Event Category is structurally different to the General Event Category. It defines
a field called <code>&quot;data&quot;</code> for placing the custom payload information, as well as
specific information related to data changes in the <code>data_type</code>. In the example
fragment below, the fields <code>&quot;a&quot;</code> and <code>&quot;b&quot;</code> are part of the custom payload housed
inside the <code>&quot;data&quot;</code> field:</p>
<pre style="font-size: .85em">
  {
    <span style="font-weight: bold;">&quot;metadata&quot;: {...}</span>
    <span style="font-weight: bold">&quot;data_op&quot;: &quot;C&quot;</span>
    <span style="font-weight: bold">&quot;data_type&quot;: &quot;example.order&quot;</span>
    <span style="font-weight: bold">&quot;data&quot;: {</span>
      <span style="color: blue;">&quot;a&quot;: &quot;a1&quot;,</span>
      <span style="color: blue;">&quot;b&quot;: &quot;b1&quot;</span>
    <span style="font-weight: bold">}</span>
  }
</pre>

<p>See the following guidelines for more guidance on how to use the Data Change Event
Category:</p>
<ul>
<li><p><a href="event.md#should-ensure-that-data-change-events-match-api-representations">&quot;Ensure that Data Change Events match API representations.&quot;</a></p>
</li>
<li><p><a href="event.md#must-use-data-change-events-to-signal-mutations">&quot;Use Data Change Events to signal mutations.&quot;</a>)</p>
</li>
<li><p><a href="event.md#should-use-the-hash-partition-strategy-for-data-change-events">&quot;Use the hash partition strategy for Data Change Events.&quot;</a>)</p>
</li>
</ul>
<p><strong>Event Metadata.</strong></p>
<p>The General and Data Change event categories share a common structure for
<em>metadata</em>. The metadata structure is shown below as an Open API Schema Object:</p>
<pre><code class="lang-yaml">  EventMetadata:
    type: object
    description: | 
      Carries metadata for an Event along with common fields. The required
      fields are those expected to be sent by the producer, other fields may be
      added by intermediaries such as publish/subscribe broker.      
    required:
      - eid
      - occurred_at      
    properties:
      eid:
        description: Identifier of this event.
        type: string
        format: uuid
        example: &apos;105a76d8-db49-4144-ace7-e683e8f4ba46&apos;
      event_type:
        description: The name of the EventType of this Event. 
        type: string
        example: &apos;example.important-business-event&apos;
      occurred_at:
        description: When the event was created according to the producer.
        type: string
        format: date-time
        example: &apos;1996-12-19T16:39:57-08:00&apos;
      received_at:      
        description: |           
          When the event was seen by an intermediary such as a broker.
        type: string
        readOnly: true
        format: date-time
        example: &apos;1996-12-19T16:39:57-08:00&apos;
      version:
        description: |    
          Version of the schema used for validating this event. This may be
          enriched upon reception by intermediaries. This string uses semantic
          versioning.          
        type: string
        readOnly: true
      parent_eids:
        description: |
          Event identifiers of the Event that caused the generation of 
          this Event. Set by the producer.      
        type: array
        items:
          type: string
          format: uuid
        example: &apos;105a76d8-db49-4144-ace7-e683e8f4ba46&apos;
      flow_id:
        description: | 
          A flow-id for this event (corresponds to the X-Flow-Id HTTP header).          
        type: string
        example: &apos;JAh6xH4OQhCJ9PutIV_RYw&apos;
      partition:
        description: |
          Indicates the partition assigned to this Event. Used for systems where
          an event type&apos;s events can be sub-divided into partitions.          
        type: string
        example: &apos;0&apos;
</code></pre>
<p>Please note than intermediaries acting between the producer of an event and its ulimate consumers, may perform operations like validation of events and enrichment of an event&apos;s <code>&quot;metadata&quot;</code>. For example brokers such as Nakadi, can validate and enrich events with arbitrary additional fields that are not specified here and may set default or other values, if some of the specified fields are not supplied. How such systems work is outside the scope of these guidelines but producers and consumers working with such systems should be look into their documentation for additional information.</p>
<h2 id="must-ensure-that-events-define-useful-business-resources"><span style="color:red;font-weight:bold">Must:</span> Ensure that Events define useful business resources</h2>
<p> Events are intended to be used by other services including business process/data analytics and monitoring. They should be based around the resources and business processes you have defined for your service domain and adhere to its natural lifecycle (see also &quot;Should: Define useful resources&quot; in the <a href="../general-guidelines/GeneralGuidelines.html">General Guidelines</a>).</p>
<p>As there is a cost in creating an explosion of event types and topics, prefer to define event types that are abstract/generic enough to be valuable for multiple use cases, and avoid publishing event types without a clear need.</p>
<h2 id="must-events-must-not-provide-sensitive-customer-personal-data"><span style="color:red;font-weight:bold">Must:</span> Events must not provide sensitive customer personal data.</h2>
<p>Similar to API permission scopes, there will be Event Type permissions passed via an OAuth token supported in near future. In the meantime, teams are asked to note the following:</p>
<ul>
<li><p>Sensitive data, such as (e-mail addresses, phone numbers, etc) are subject to strict access and data protection controls. </p>
</li>
<li><p>Event type owners <strong>must not</strong> publish sensitive information unless it&apos;s mandatory or neccessary to do so. For example, events sometimes need to provide personal data, such as delivery addresses in shipment orders  (as do other APIs), and this is fine.</p>
</li>
</ul>
<h2 id="must-use-the-general-event-category-to-signal-steps-and-arrival-points-in-business-processes"><span style="color:red;font-weight:bold">Must:</span> Use the General Event Category to signal steps and arrival points in business processes</h2>
<p>When publishing events that represent steps in a business process, event types
must be based on the General Event category.</p>
<p>All your events of a single business process will conform to the following rules:</p>
<ul>
<li><p>Business events must contain a specific identifier field (a business process id or &quot;bp-id&quot;) similar to flow-id to allow for efficient aggregation of all events in a business process execution.</p>
</li>
<li><p>Business events must contain a means to correctly order events in a business process execution. In distributed settings where monotically increasing values (such as a high precision timestamp that is assured to move forwards) cannot be obtained, the <code>parent_eids</code> data structure allows causal relationships to be declared between events.</p>
</li>
<li><p>Business events should only contain information that is new to the business process execution at the specific step/arrival point.</p>
</li>
<li><p>Each business process sequence should be started by a business event containing all relevant context information.</p>
</li>
<li><p>Business events must be published reliably by the service.</p>
</li>
</ul>
<p>At the moment we cannot state whether it&apos;s best practice to publish all the events for a business process using a single event type and represent the specific steps with a state field, or whether to use multiple event types to represent each step. For now we suggest assessing each option and sticking to one for a given business process.</p>
<h2 id="must-use-data-change-events-to-signal-mutations"><span style="color:red;font-weight:bold">Must:</span> Use Data Change Events to signal mutations</h2>
<p>When publishing events that represents created, updated, or deleted data, change
event types must be based on the Data Change Event category.</p>
<ul>
<li>Change events must identify the changed entity to allow aggregation of all related events for the entity.</li>
<li>Change events should <a href="#should-provide-a-means-of-event-ordering">contain a means of ordering</a> events for a given entity.</li>
<li>Change events must be published reliably by the service.</li>
</ul>
<h2 id="should-provide-a-means-for-explicit-event-ordering"><span style="color:darkgoldenrod;font-weight:bold">Should:</span> Provide a means for explicit event ordering</h2>
<p>Some common error cases may require event consumers to reconstruct event streams or replay events from a position within the stream. Events <em>should</em> therefore contain a way to restore their partial order of occurence.</p>
<p>This can be done - among other ways -  by adding</p>
<ul>
<li>a strictly monotonically increasing entity version (e.g. as created by a database) to allow for partial ordering of all events for an entity</li>
<li>a strictly monotonically increasing message counter</li>
</ul>
<p>System timestamps are not necessarily a good choice, since exact synchronization of clocks in distributed systems is difficult, two events may occur in the same microsecond and system clocks may jump backward or forward to compensate drifts or leap-seconds. If you use system timestamps to indicate event ordering, you must carefully ensure that your designated event order is not messed up by these effects. </p>
<p><strong>Note</strong> that basing events on data structures that can be converged upon in a distributed setting (such as <a href="https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type" target="_blank">CRDTs</a>, <a href="https://en.wikipedia.org/wiki/Logical_clock" target="_blank">logical clocks</a> and <a href="https://en.wikipedia.org/wiki/Vector_clock" target="_blank">vector clocks</a>) is outside the scope of this guidance.</p>
<h2 id="should-use-the-hash-partition-strategy-for-data-change-events"><span style="color:darkgoldenrod;font-weight:bold">Should:</span> Use the hash partition strategy for Data Change Events</h2>
<p>The <code>hash</code> partition strategy allows a producer to define which fields in an event are used as input to compute a logical partition the event should be added to. Partitions are useful as they allow supporting systems to scale their throughput while provide local ordering for event entities.</p>
<p>The <code>hash</code> option is particulary useful for data changes as it allows all related events for an entity to be consistently assigned to a partition, providing a relative ordered stream of events for that entity. This is because while each partition has a total ordering, ordering across partitions is not assured by a supporting system, thus it is possible for events sent across partitions to appear in a different order to consumers that the order they arrived at the server.</p>
<p>When using the <code>hash</code> strategy the partition key in almost all cases should represent the entity being changed and not a per event or change identifier such as the <code>eid</code> field or a timestamp. This ensures data changes arrive at the same partition for a given entity and can be consumed effectively by clients.</p>
<p>There may be exceptional cases where data change events could have their partition strategy set to be the producer defined or random options, but generally <code>hash</code> is the right option - that is while the guidelines here are a &quot;should&quot;, they can be read as &quot;must, unless you have a very good reason&quot;. </p>
<h2 id="should-ensure-that-data-change-events-match-api-representations"><span style="color:darkgoldenrod;font-weight:bold">Should:</span> Ensure that Data Change Events match API representations</h2>
<p>A data change event&apos;s representation of an entity should correspond to the REST API representation. </p>
<p>There&apos;s value in having the fewest number of published structures for a service. Consumers of the service will be working with fewer representations, and the service owners will have less API surface to maintain. In particular, you should only publish events that are interesting in the domain and abstract away from implementation or local details - there&apos;s no need to reflect every change that happens within your system.</p>
<p>There are cases where it could make sense to define data change events that don&apos;t directly correspond to your API resource representations. Some examples are -</p>
<ul>
<li><p>Where the API resource representations are very different from the datastore representation, but the physical data are easier to reliably process for data integration.</p>
</li>
<li><p>Publishing aggregated data. For example a data change to an individual entity might cause an event to be published that contains a coarser representation than that defined for an API</p>
</li>
<li><p>Events that are the result of a computation, such as a matching algorithm, or the generation of enriched data, and which might not be stored as entity by the service. </p>
</li>
</ul>
<h2 id="must-permissions-on-events-must-correspond-to-api-permissions"><span style="color:red;font-weight:bold">Must:</span> Permissions on events must correspond to API permissions</h2>
<p>If a resource can be read synchronously via a REST API and read asynchronously via an event, the same read-permission must apply: We want to protect access to data, not the way data is accessed.</p>
<h2 id="must-indicate-ownership-of-event-types"><span style="color:red;font-weight:bold">Must:</span> Indicate ownership of Event Types</h2>
<p>Event definitions must have clear ownership - this can be indicated via the <code>owning_application</code> field of the EventType. </p>
<p>Typically there is one producer application, which owns the EventType and is responsible for its definition, akin to how RESTful API definitions are managed. However, the owner may also be a particular service from a set of multiple services that are producing the same kind of event.</p>
<h2 id="must-define-event-payloads-in-accordance-with-the-overall-guidelines"><span style="color:red;font-weight:bold">Must:</span> Define Event Payloads in accordance with the overall Guidelines</h2>
<p>Events must be consistent with other API data and the API Guidelines in general. </p>
<p>Everything expressed in the <a href="../index.html">Introduction to these Guidelines</a> is applicable to event data interchange between services. This is because our events, just like our APIs, represent a commitment to express what our systems do and designing high-quality, useful events allows us to develop new and interesting products and services. </p>
<p>What distinguishes events from other kinds of data is the delivery style used, asynchronous publish-subscribe messaging. But there is no reason why they could not be made available using a REST API, for example via a search request or as a paginated feed, and it will be common to base events on the models created for the service&#x2019;s REST API. </p>
<p>The following existing guideline sections are applicable to events -</p>
<ul>
<li><p><a href="../general-guidelines/GeneralGuidelines.html">General Guidelines</a> </p>
</li>
<li><p><a href="../naming/Naming.html">Naming</a></p>
</li>
<li><p><a href="../data-formats/DataFormats.html">Data Formats</a></p>
</li>
<li><p><a href="../common-data-types/CommonDataTypes.html">Common Data Objects</a></p>
</li>
<li><p><a href="../hyper-media/Hypermedia.html">Hypermedia</a> - </p>
</li>
</ul>
<h2 id="must-maintain-backwards-compatibility-for-events"><span style="color:red;font-weight:bold">Must:</span> Maintain backwards compatibility for Events</h2>
<p>Changes to events must be based around making additive and backward compatible changes. This follows the guideline, &quot;Must: Don&#x2019;t Break Backward Compatibility&quot; from the <a href="../compatibility/Compatibility.html">Compatibility guidelines</a>. </p>
<p>In the context of events, compatibility issues are complicated by the fact that producers and consumers of events are highly asynchronous and can&#x2019;t use content-negotiation techniques that are available to REST style clients and servers. This places a higher bar on producers to maintain compatibility as they will not be in a position to serve versioned media types on demand. </p>
<p>For event schema, these are considered backward compatible changes, as seen by consumers  -</p>
<ul>
<li>Adding new optional fields to JSON objects.</li>
<li>Changing the order of fields (field order in objects is arbitrary).</li>
<li>Changing the order of values with same type in an array.</li>
<li>Removing optional fields.</li>
<li>Removing an individual value from an enumeration.</li>
</ul>
<p>These are considered backwards-incompatible changes, as seen by consumers  -</p>
<ul>
<li>Removing required fields from JSON objects.</li>
<li>Changing the default value of a field.</li>
<li>Changing the type of a field, object, enum or array.</li>
<li>Changing the order of values with different type in an array (also known as a tuple).</li>
<li>Adding a new optional field to redefine the meaning of an existing field (also known as a co-occurrence constraint).</li>
<li>Adding a value to an enumeration (note that <a href="../compatibility/Compatibility.html#should-used-openended-list-of-values-xextensibleenum-instead-of-enumerations"><code>x-extensible-enum</code></a> is not available in JSON Schema).</li>
</ul>
<h2 id="should-avoid-additionalproperties-in-event-type-definitions"><span style="color:darkgoldenrod;font-weight:bold">Should:</span> Avoid <code>additionalProperties</code> in event type definitions</h2>
<p>Event type schema should avoid using <code>additionalProperties</code> declarations, in 
order to support schema evolution.</p>
<p>Events are often intermediated by publish/subscribe systems and are 
commonly captured in logs or long term storage to be read later. In 
particular, the schemas used by publishers and consumers can<br>drift over time. As a result, compatibility and extensibility issues 
that happen less frequently with client-server style APIs become important 
and regular considerations for event design. The guidelines recommend the 
following to enable event schema evolution:</p>
<ul>
<li><p>Publishers who intend to provide compatibility and allow their schemas 
to evolve safely over time  <strong>must not</strong> declare an <code>additionalProperties</code> 
field with a value of <code>true</code> (i.e., a wildcard extension point). Instead 
they must define new optional fields and update their schemas in advance 
of publishing those fields. </p>
</li>
<li><p>Consumers <strong>must</strong> ignore fields they cannot process and not raise 
errors. This can happen if they are 
processing events with an older copy of the event schema than the one
containing the new definitions specified by the publishers. </p>
</li>
</ul>
<p>The above constraint does not mean fields can never be added in 
future revisions of an event type schema - additive compatible 
changes are allowed, only that the new schema for an event type 
must define the field first before it is published within an 
event. By the same turn the consumer must ignore fields it does not 
know about from its copy of the schema, just as they would as an API 
client - that is, they cannot treat the absence of an 
<code>additionalProperties</code> field as though the event type schema was 
closed for extension.</p>
<p>Requiring event publishers to define their fields ahead of publishing avoids 
the problem of <em>field redefinition</em>. This is when a publisher defines a 
field to be of a different type that was already being emitted, or, is 
changing the type of an undefined field. Both of these are prevented by 
not using <code>additionalProperties</code>. </p>
<p>See also &quot;Treat Open API Definitions As Open For Extension By Default&quot;<br>in the <a href="../compatibility/Compatibility.html#must-treat-open-api-definitions-as-open-for-extension-by-default">Compatibility</a> 
section for further guidelines on the use of <code>additionalProperties</code>. </p>
<h2 id="must-use-unique-event-identifiers"><span style="color:red;font-weight:bold">Must:</span> Use unique Event identifiers</h2>
<p>The <code>eid</code> (event identifier) value of an event must be unique.</p>
<p>The <code>eid</code> property is part of the standard metadata for an event and gives the event an identifier. Producing clients must generate this value when sending an event and it must be guaranteed to be unique from the perspective of the owning application. In particular events within a given event type&apos;s stream must have unique identifiers. This allows consumers to process the <code>eid</code> to assert the event is unique and use it as an idempotency check. </p>
<p>Note that uniqueness checking of the <code>eid</code> might be not enforced by systems consuming events and it is the responsibility of the producer to ensure event identifiers do in fact distinctly identify events. A straightforward way to create a unique identifier for an event is to generate a UUID value.</p>
<h2 id="should-design-for-idempotent-outoforder-processing"><span style="color:darkgoldenrod;font-weight:bold">Should:</span> Design for idempotent out-of-order processing</h2>
<p>Events that are designed for <a href="#must-use-unique-event-identifiers">idempotent</a> out-of-order processing allow for extremely resilient systems: If processing an event fails, consumers and producers can skip/delay/retry it without stopping the world or corrupting the processing result. </p>
<p>To enable this freedom of processing, you must explicitly design for idempotent out-of-order processing: Either your events must contain enough information to infer their original order during consumption or your domain must be designed in a way that order becomes irrelevant.</p>
<p>As common example similar to data change events, idempotent out-of-order processing can be supported by sending the following information:</p>
<ul>
<li>the process/resource/entity identifier,</li>
<li>a <a href="#should-provide-a-means-of-event-ordering">monotonically increasing ordering key</a> and</li>
<li>the process/resource state after the change.</li>
</ul>
<p>A receiver that is interested in the current state can then ignore events that are older than the last processed event of each resource. A receiver interested in the history of a resource can use the ordering key to recreate a (partially) ordered sequence of events.</p>
<h2 id="must-follow-conventions-for-event-type-names"><span style="color:red;font-weight:bold">Must:</span> Follow conventions for Event Type names</h2>
<p>Event types can follow these naming conventions (each convention has its own should, must or could conformance level) -</p>
<ul>
<li><p>Event type names must be url-safe. This is because the event type names may appear in URLs published by other systems and APIs.</p>
</li>
<li><p>Event type names should be lowercase words and numbers, using hyphens, underscores or periods as separators.</p>
</li>
</ul>
<h2 id="must-prepare-for-duplicate-events"><span style="color:red;font-weight:bold">Must:</span> Prepare for duplicate Events</h2>
<p>Event consumers must be able to process duplicate events.</p>
<p>Most message brokers and data streaming systems offer &#x201C;at-least-once&#x201D; delivery. That is, one particular event is delivered to the consumers one or more times. Other circumstances can also cause duplicate events.</p>
<p>For example, these situations occur if the publisher sends an event and doesn&apos;t receive the acknowledgment (e.g. due to a network issue). In this case, the publisher will try to send the same event again. This leads to two identical events in the event bus which have to be processed by the consumers. Similar conditions can appear on consumer side: an event has been processed successfully, but the consumer fails to confirm the processing.</p>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../api-operation/ApiOperation.html" class="navigation navigation-prev " aria-label="Previous page: API Operation"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../references/References.html" class="navigation navigation-next " aria-label="Next page: References"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="../gitbook/plugins/gitbook-plugin-edit-link/plugin.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-search/lunr.min.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-search/search.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-fontsettings/buttons.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"structured-toc":{},"gitbook-restructure-navigation":{"transformations":[{"from":0,"to":1}]},"edit-link":{"base":"https://github.com/zalando/restful-api-guidelines/edit/master","label":"Edit This Page"},"restructure-navigation":{},"anchors":{},"highlight":{},"search":{"maxIndexSize":1000000},"fontsettings":{"family":"sans","size":2,"theme":"white"}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
